---
- name: Create Tomcat file repository
  hosts: "{{sat_host}}"
  become: True
  gather_facts: False

  vars:

    app_version: 8

    app: 'tomcat'

  tasks:

    - name: Unlock Satellite maintain packages
      command: >
        satellite-maintain packages unlock

    - name: Install pulp manifest package
      ansible.builtin.dnf:
        name: python39-pulp_manifest
        state: present

    - name: Lock Satellite maintain packages
      command: >
        satellite-maintain packages lock

    - name: Create directory to host file repsository
      ansible.builtin.file:
        state: directory
        path: '/var/lib/pulp/local_repos/{{app}}/8'

    - name: Create directory to host file repsository
      ansible.builtin.file:
        state: directory
        path: '/var/lib/pulp/local_repos/{{app}}/9'
  
    - name: Find latest version of {{app}} 8
      ansible.builtin.shell: |
          curl .. https://archive.apache.org/dist/tomcat/tomcat-8/|sed -n 's/.*href="\([^"]*\).*/\1/p'| grep '^v'
      register: tomcat_list_8
  
    - name: Find latest version of {{app}} 9
      ansible.builtin.shell: |
         curl .. https://archive.apache.org/dist/tomcat/tomcat-9/|sed -n 's/.*href="\([^"]*\).*/\1/p'| grep '^v'    
      register: tomcat_list_9

    - name: Set facts for latest Tomcat 8 version
      ansible.builtin.set_fact:
        tomcat_8_latest_version: "{{ tomcat_list_8.stdout_lines | last | regex_replace('/^\/?|\/?$/g, ""') }}"

    - ansible.builtin.debug:
        var: tomcat_8_latest_version
    
    - ansible.builtin.debug:
        var: tomcat_list_9.stdout_lines

    - name: Download latest version of tomcat 8
      ansible.builtin.get_url:
        url: https://archive.apache.org/dist/tomcat/tomcat-8/{{tomcat_list_8.stdout_lines|last}}/bin/apache-tomcat-
        dest: /var/lib/pulp/local_repos/{{app}}/8

    - name: Download latest version of tomcat 9
      ansible.builtin.get_url:
        url: https://archive.apache.org/dist/tomcat/tomcat-9/{{tomcat_list_9.stdout_lines|last}}/bin/apache-tomcat-
        dest: /var/lib/pulp/local_repos/{{app}}/9

    - name: Add the parent folder into allowed import paths
      ansible.builtin.shell: |
        {foreman-installer} --foreman-proxy-content-pulpcore-additional-import-paths /var/lib/pulp/local_repos

    - name: Run the pulp manifest command to create manifest
      ansible.builtin.shell: |
        pulp-manifest /var/lib/pulp/local_repos/{{app}}/8
  
    - name: Run the pulp manifest command to create manifest
      ansible.builtin.shell: |
        pulp-manifest /var/lib/pulp/local_repos/{{app}}/9